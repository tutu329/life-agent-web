# 可视化分析功能开发计划

## 项目概述
在现有的三栏布局中添加可视化分析功能，能够显示后台返回的动态JS代码的渲染结果。

## 功能需求
1. **主要目标**：显示后台返回的动态JS类代码的渲染结果
2. **布局设计**：上下分布结构
   - 上部：动态代码对应的渲染区（60-70%高度）
   - 下部：动态代码显示框（30-40%高度），类似ChatGPT样式，包含代码复制按钮
3. **交互特性**：上下区域可独立滚动
4. **初始状态**：页面启动时显示固定的漂亮多曲线交互图表作为测试用例

## 技术选型
- **图表库**：ECharts 5.x（功能强大、交互丰富、国内生态友好）
- **代码高亮**：react-syntax-highlighter（支持复制按钮）
- **代码执行**：new Function() 动态执行（后续可扩展为iframe沙箱）
- **UI框架**：继续使用Ant Design保持一致性

## 目录结构
```
src/components/
├── VisualAnalysisPanel.tsx     # 主面板组件
├── visualSamples.ts            # 固定示例代码库
└── visual/                     # 可视化相关子组件
    ├── RenderSurface.tsx       # 渲染表面组件
    └── CodeViewer.tsx          # 代码查看器组件
```

## 实施阶段

### 第一阶段：基础框架搭建
- [x] 创建开发计划文档
- [ ] 安装必要依赖（echarts, react-syntax-highlighter）
- [ ] 创建VisualAnalysisPanel主组件
- [ ] 创建基础的上下分栏布局
- [ ] 集成到现有页面结构中

### 第二阶段：示例代码实现
- [ ] 编写固定的多曲线交互图表示例代码
- [ ] 实现代码动态执行机制
- [ ] 添加代码高亮显示
- [ ] 实现代码复制功能

### 第三阶段：样式优化
- [ ] 优化渲染区域样式
- [ ] 优化代码显示区域样式
- [ ] 添加响应式布局支持
- [ ] 统一主题风格

### 第四阶段：功能扩展预留
- [ ] 预留后台动态代码接口
- [ ] 添加错误处理机制
- [ ] 支持多种图表类型
- [ ] 添加代码执行沙箱

## 组件设计

### VisualAnalysisPanel 主组件
```typescript
interface VisualAnalysisPanelProps {
  codeString?: string;           // 动态代码字符串
  onCodeExecute?: (code: string) => void;  // 代码执行回调
}
```

### 示例代码结构
```javascript
// 多曲线交互图表示例
const sampleLineChartCode = `
const option = {
  title: { text: '多曲线交互图表示例' },
  tooltip: { trigger: 'axis' },
  legend: { data: ['销售额', '利润', '访问量'] },
  xAxis: { 
    type: 'category', 
    data: ['1月','2月','3月','4月','5月','6月'] 
  },
  yAxis: { type: 'value' },
  series: [
    { name:'销售额', type:'line', smooth:true, data:[120,132,101,134,90,230]},
    { name:'利润', type:'line', smooth:true, data:[220,182,191,234,290,330]},
    { name:'访问量', type:'line', smooth:true, data:[150,232,201,154,190,330]}
  ]
};
dom.setOption(option);
`;
```

## 集成方案
1. **位置选择**：在EditorPanel中添加新的Tab页"可视化分析"
2. **路由管理**：使用现有的Tab切换机制
3. **状态管理**：利用现有的Context系统
4. **样式继承**：保持与现有组件的视觉一致性

## 安全考虑
- 初期使用Function构造函数执行代码
- 限制可访问的全局变量
- 后续考虑iframe沙箱或Web Workers
- 添加代码执行超时机制

## 性能优化
- 图表实例复用
- 代码执行防抖
- 大数据量时的虚拟滚动
- 按需加载图表库

## 测试计划
1. **单元测试**：组件渲染、代码执行、错误处理
2. **集成测试**：与现有系统的集成
3. **性能测试**：大量数据渲染性能
4. **兼容性测试**：不同浏览器的兼容性

## 后续扩展
1. **多图表支持**：支持同时显示多个图表
2. **图表类型扩展**：支持更多ECharts图表类型
3. **交互增强**：图表与代码的双向交互
4. **数据源集成**：连接后台数据源
5. **模板系统**：预设常用图表模板

## 时间安排
- 第一阶段：1天（基础框架）
- 第二阶段：1天（示例实现）
- 第三阶段：0.5天（样式优化）
- 第四阶段：0.5天（功能预留）

**总计：3天完成基础版本**

## 风险评估
- **低风险**：基于现有技术栈，不改动核心逻辑
- **中风险**：动态代码执行的安全性需要持续关注
- **技术债务**：后续需要考虑更完善的沙箱机制

## 成功标准
1. 页面启动时能正确显示示例图表
2. 代码区域能正确高亮显示并支持复制
3. 上下区域能独立滚动
4. 与现有页面风格保持一致
5. 为后台动态代码预留良好的接口 